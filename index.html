<html>

<head>
  <title>Binary Calculator</title>
</head>
<!--
    Simple calculator for binary numbers.
    Copyright (C) 2019 Oliver Lau <ola@ct.de>, Heise Medien GmbH & Co. KG

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <https://www.gnu.org/licenses/>.
-->
<style type="text/css">
  * {
    margin: 0;
    padding: 0;
  }

  html,
  body {
    background-color: #e9e7de;
    font-family: 'Courier New', Courier, monospace;
    font-size: 12pt;
  }

  h1 {
    font-size: 18pt;
  }

  .app {
    padding: 5pt;
  }

  .container {
    margin: 5pt auto;
  }

  textarea {
    background-color: white;
    color: black;
    font-family: "Courier New", Courier, monospace;
    font-size: 12pt;
    padding: 4pt;
    width: 100%;
    height: 50pt;
  }
</style>
<script type="text/javascript">
  (function (window) {
    'use strict';
    let inEl = null;
    let outEl = null;
    let msgEl = null;
    let baseFormEl = null;
    let values = [];
    let ops = [];
    let base = localStorage.getItem('base') || 2;
    const Padding = (function (length) {
      let padding = '';
      for (let i = 0; i < length; ++i) {
        padding += '0';
      }
      return padding;
    })(512);

    class Token {
      constructor(type, value) {
        this.type = type;
        this.value = value;
      }
    }

    Token.Type = {
      Literal: 1,
      Operator: 2
    };

    Token.Types = [
      { regex: /^\s+/, type: Token.Type.Space, ignore: true },
      { regex: /^[\^\&\|\+-]/, type: Token.Type.Operator, ignore: false },
      { base: +2, regex: /^[01]+/, type: Token.Type.Literal, ignore: false },
      { base: +8, regex: /^[0-7]+/, type: Token.Type.Literal, ignore: false },
      { base: +10, regex: /^[0-9]+/, type: Token.Type.Literal, ignore: false },
      { base: +16, regex: /^[0-9a-fA-F]+/, type: Token.Type.Literal, ignore: false },
    ];

    let tokenize = str => {
      let tokens = [];
      let expr = str;
      while (expr.length > 0) {
        let found = false;
        for (let i = 0; i < Token.Types.length && !found; ++i) {
          let t = Token.Types[i];
          if (Number.isInteger(t.base) && t.base !== base) {
            continue;
          }
          let m = expr.match(t.regex);
          if (m && m.length > 0) {
            if (!t.ignore) {
              let value;
              if (t.type === Token.Type.Literal) {
                value = parseInt(m[0], base);
                if (isNaN(value)) {
                  return {error: 'invalid literal: ${m[0]}'};
                }
              }
              else {
                value = m[0];
              }
              tokens.push(new Token(t.type, value));
            }
            expr = expr.substring(m[0].length);
            found = true;
          }
        }
        if (!found) {
          return {error: `invalid expression`};
        }
      }
      return {
        tokens: tokens
      };
    }

    let formulaChanged = event => {
      let result = tokenize(inEl.value);
      if (result.error) {
        msgEl.innerText = result.error;
        return;
      }
      else {
        msgEl.innerText = '';
      }
      let tokens = result.tokens;
      console.log('tokens before', tokens);
      if (tokens) {
        let ops = [];
        let values = [];
        for (const token of tokens) {
          switch (token.type) {
            case Token.Type.Literal:
              values.push(token.value);
              break;
            case Token.Type.Operator:
              ops.push(token.value);
              break;
            default:
              break;
          }
        }
        console.log("BEFORE ** ops:", ops, "values:", values);
        let r = undefined;
        while (ops.length > 0) {
          console.log("values", values);
          let op = ops.shift();
          let a = values.shift();
          let b = values.shift();
          switch (op) {
            case '^':
              r = a ^ b;
              break;
            case '|':
              r = a | b;
              break;
            case '&':
              r = a & b;
              break;
            case '+':
              r = a + b;
              break;
            case '-':
              r = a - b;
              break;
          }
          if (Number.isInteger(r)) {
            values.unshift(r);
          }
        }
        if (values.length === 1) {
          outEl.value = values.pop().toString(base);
        }
        else {
          msgEl.innerText = 'invalid expression';
        }
        console.log("AFTER ** ops:", ops, "values:", values);
      }
    };
    let baseChanged = event => {
      base = parseInt(event.target.value);
      localStorage.setItem('base', base);
      formulaChanged();
    };
    let main = () => {
      inEl = document.getElementById('input');
      inEl.addEventListener('input', formulaChanged);
      outEl = document.getElementById('output');
      msgEl = document.getElementById('msg');
      baseFormEl = document.getElementById('base-form');
      baseFormEl.addEventListener('change', baseChanged);
      document.getElementById(`base-${base}`).checked = true;
    }
    window.addEventListener('load', main);
  })(window);
</script>

<body>
  <div class="app">
    <h1>Binary Calculator</h1>
    <div class="container">
      <form id="base-form">
        <input id="base-2" name="base" type="radio" value="2"></option>
        <label for="base-2">binary</label>
        <input id="base-8" name="base" type="radio" value="8"></option>
        <label for="base-8">octal</label>
        <input id="base-10" name="base" type="radio" value="10"></option>
        <label for="base-10">decimal</label>
        <input id="base-16" name="base" type="radio" value="16"></option>
        <label for="base-16">hexadecimal</label>
      </form>
    </div>
    <div class="container"><textarea id="input"
        placeholder="type formula here, e.g. '1001 ^ 1111' to XOR two values"></textarea></div>
    <div class="container"><textarea id="output" readonly placeholder="result will be displayed here"></textarea></div>
    <div class="container"><span id="msg"></span></div>
  </div>
</body>

</html>