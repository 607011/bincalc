<html>

<head>
  <title>Binary Calculator</title>
</head>
<!--
    Simple calculator for binary numbers.
    Copyright (C) 2019 Oliver Lau <ola@ct.de>, Heise Medien GmbH & Co. KG

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <https://www.gnu.org/licenses/>.
-->
<style type="text/css">
  * {
    margin: 0;
    padding: 0;
  }

  html,
  body {
    background-color: #e9e5ce;
    font-family: 'Courier New', Courier, monospace;
  }

  .app {
    padding: 5pt;
  }

  .container {
    margin: 5pt auto;
  }

  textarea {
    background-color: white;
    color: black;
    font-family: "Courier New", Courier, monospace;
    font-size: 12pt;
    padding: 4pt;
    width: 100%;
    height: 50pt;
  }
</style>
<script type="text/javascript">
  (function (window) {
    'use strict';
    let inEl = null;
    let outEl = null;
    let msgEl = null;
    let values = [];
    let ops = [];
    const base = 2;
    const Padding = '00000000000000000000000000000000';

    class Token {
      constructor(type, value) {
        this.type = type;
        this.value = value;
      }
    }

    Token.Type = {
      Literal: 1,
      Operator: 2
    };

    Token.Types = [
      { regex: /^[01]+/, type: Token.Type.Literal, ignore: false },
      { regex: /^[\^\&\|\+-]/, type: Token.Type.Operator, ignore: false },
      { regex: /^\s+/, type: Token.Type.Space, ignore: true },
    ];

    let tokenize = str => {
      let tokens = [];
      let expr = str;
      while (expr.length > 0) {
        let found = false;
        for (let i = 0; i < Token.Types.length && !found; ++i) {
          let t = Token.Types[i];
          let m = expr.match(t.regex);
          if (m && m.length > 0) {
            if (!t.ignore) {
              let value = (t.type === Token.Type.Literal)
                ? parseInt(m[0], base)
                : m[0];
              tokens.push(new Token(t.type, value));
            }
            expr = expr.substring(m[0].length);
            found = true;
          }
        }
        if (!found) {
          return;
        }
      }
      return tokens;
    }

    let formulaChanged = event => {
      let tokens = tokenize(inEl.value);
      if (tokens) {
        let ops = [];
        let values = [];
        for (const token of tokens) {
          switch (token.type) {
            case Token.Type.Literal:
              values.push(token.value);
              break;
            case Token.Type.Operator:
              ops.push(token.value);
              break;
            default:
              break;
          }
        }
        let r = undefined;
        while (ops.length > 0) {
          let op = ops.shift();
          let a = values.shift();
          let b = values.shift();
          switch (op) {
            case '^':
              r = a ^ b;
              break;
            case '|':
              r = a | b;
              break;
            case '&':
              r = a & b;
              break;
            case '+':
              r = a + b;
              break;
            case '-':
              r = a - b;
              break;
          }
          if (r) {
            values.push(r);
          }
        }
        if (r) {
          outEl.value = values.pop().toString(base);
          if (values.length === 0 && ops.length === 0) {
            msgEl.innerText = '';
          }
          else {
            msgEl.innerText = 'invalid expression';
          }
        }
      }
    };
    let main = () => {
      inEl = document.getElementById('input');
      inEl.addEventListener('input', formulaChanged);
      outEl = document.getElementById('output');
      msgEl = document.getElementById('msg');
    }
    window.addEventListener('load', main);
  })(window);
</script>

<body>
  <div class="app">
    <h1>Binary Calculator</h1>
    <div class="container"><textarea id="input"
        placeholder="type formula here, e.g. '1001 ^ 1111' to XOR two values"></textarea></div>
    <div class="container"><textarea id="output" readonly placeholder="result will be displayed here"></textarea></div>
    <div class="container"><span id="msg"></span></div>
  </div>
</body>

</html>